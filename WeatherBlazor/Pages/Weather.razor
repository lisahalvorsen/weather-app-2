@page "/weather"
@using System.Globalization
@using WeatherShared
@inject HttpClient Http
@inject IConfiguration Configuration
@namespace WeatherBlazor.Pages

<img id="logo" src="img/brislogo.png" alt="Bris logo"/>

@if (string.IsNullOrEmpty(_selectedCity))
{
    <h3>Hvordan er været i dag?</h3>
}
else
{
    <h3>Akkurat nå i @CultureInfo.CurrentCulture.TextInfo.ToTitleCase(_selectedCity)</h3>
}

<div id="date">@GetFormattedDate()</div>

<div id="search-container">
    <input @bind="_city" placeholder="Se værmelding for Paris"/>
    <button @onclick="GetWeatherForecast">Se været <img id="sun" src="img/sunicon.png" alt="Sun icon"/></button>
</div>

@if (_weatherData != null)
{
    <div id="weather-data-container">
        <div>Temperatur: @Math.Round(_weatherData.Temperature, 1)°C</div>
        <div>Føles som: @Math.Round(_weatherData.FeelsLike, 1)°C</div>
        <div>Beskrivelse: @CapitalizeFirstLetter(_weatherData.Description) @GetWeatherEmoji()</div>        <div>Luftfuktighet: @_weatherData.Humidity%</div>
        <div>Vind: @Math.Round(_weatherData.WindSpeed, 1) m/s (@GetWindDirection(_weatherData.WindDirection))</div>    </div>
}

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div id="error-message">@_errorMessage</div>
}

@code {
    private string? _city;
    private string? _selectedCity;
    private WeatherData? _weatherData;
    private string? _errorMessage;
    private readonly DateTime _currentDate = DateTime.Now;

    private async Task GetWeatherForecast()
    {
        if (string.IsNullOrWhiteSpace(_city))
        {
            _errorMessage = "Vennligst skriv inn en by.";
            return;
        }

        try
        {
            var baseUrl = Configuration["ApiBaseUrl"] ?? "https://localhost:7291";
            var apiUrl = $"{baseUrl}/api/weather/{_city}";

            var response = await Http.GetAsync(apiUrl);

            if (!response.IsSuccessStatusCode)
            {
                _errorMessage = $"Feil fra API: {response.StatusCode}";
                return;
            }

            _weatherData = await response.Content.ReadFromJsonAsync<WeatherData>();
            _errorMessage = null;
            _selectedCity = _city;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Noe gikk galt: {ex.Message}";
        }

        _city = "";
    }

    private string GetWeatherEmoji()
    {
        var emoji = _weatherData.Condition switch
        {
            WeatherCondition.Clear => "☀️",
            WeatherCondition.Clouds => "☁️",
            WeatherCondition.Rain => "🌧️",
            WeatherCondition.Snow => "🌨️",
            WeatherCondition.Sun => "☀️",
            WeatherCondition.Wind => "💨",
            WeatherCondition.Other => "❔",
            _ => ""
        };

        return emoji;
    }

    private string GetFormattedDate()
    {
        var culture = new CultureInfo("nb-NO");
        var formattedDate = _currentDate.ToString("dddd d. MMMM", culture);
        return char.ToUpper(formattedDate[0]) + formattedDate[1..];
    }

    private string CapitalizeFirstLetter(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return "";
        }

        return char.ToUpper(text[0]) + text[1..].ToLower();
    }

    private string GetWindDirection(float degrees)
    {
        string[] directions = { "N", "NØ", "Ø", "SØ", "S", "SV", "V", "NV", "N" };
        return directions[(int)Math.Round(((double)degrees % 360) / 45)];
    }

}